<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>4 Gewinnt â€“ Tier-Duell (Link-Spiel)</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121823; --ink:#e8eef7; --muted:#9bb0c5;
      --red:#ff4d5e; --yellow:#ffd34d; --grid:#0f253b; --win:#35e0a1;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:radial-gradient(1000px 600px at 10% 0%,#13253b,var(--bg));
      color:var(--ink); display:grid; place-items:center; min-height:100svh; padding:24px;
    }
    .wrap{width:100%; max-width:900px}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; gap:10px; flex-wrap:wrap}
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    button{
      appearance:none; border:1px solid rgba(255,255,255,.15); color:var(--ink);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      padding:10px 12px; border-radius:12px; cursor:pointer; font-size:14px;
    }
    button:hover{border-color:rgba(255,255,255,.28)}
    select{
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.04);
      color:var(--ink);
      padding:10px 12px;
      border-radius:12px;
      font-size:14px;
      outline:none;
    }
    .status{
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.1); border-radius:14px; padding:12px 14px; margin-bottom:10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .who{display:flex; align-items:center; gap:10px}
    .disc{width:20px; height:20px; border-radius:50%}
    .disc.red{background:var(--red); box-shadow:0 0 0 2px rgba(255,77,94,.25)}
    .disc.yellow{background:var(--yellow); box-shadow:0 0 0 2px rgba(255,211,77,.25)}
    .muted{color:var(--muted)}
    .note{font-size:13px; color:var(--muted)}
    .board-wrap{
      background:var(--card); border:1px solid rgba(255,255,255,.1);
      border-radius:18px; padding:14px; box-shadow:0 10px 35px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
      margin-top:6px;
    }
    .board{
      --cols:7; --rows:6;
      display:grid; grid-template-columns:repeat(var(--cols), 1fr); gap:10px;
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
      padding:10px; border-radius:14px;
    }
    .col{display:grid; grid-template-rows:repeat(var(--rows), 1fr); gap:10px; cursor:pointer}
    .col.disabled{pointer-events:none; opacity:.65}
    .cell{
      width:100%; aspect-ratio:1/1; border-radius:50%;
      background:radial-gradient(circle at 35% 35%, #1b3958, var(--grid));
      display:grid; place-items:center; position:relative; overflow:hidden;
      box-shadow:inset 0 5px 10px rgba(0,0,0,.5), inset 0 -4px 8px rgba(0,0,0,.35);
    }
    .chip{
      width:90%; height:90%; border-radius:50%; transform:translateY(-140%); opacity:0;
      transition:transform .22s cubic-bezier(.2,.9,.2,1.2), opacity .12s ease;
    }
    .chip.show{transform:translateY(0); opacity:1}
    .chip.red{background:radial-gradient(circle at 35% 35%, #ff8a96, var(--red))}
    .chip.yellow{background:radial-gradient(circle at 35% 35%, #ffe89a, var(--yellow))}
    .cell.win{outline:3px solid var(--win); outline-offset:-3px; box-shadow:0 0 0 3px rgba(53,224,161,.18), inset 0 0 0 999px rgba(53,224,161,.08)}
    .last{box-shadow:inset 0 0 0 3px rgba(255,255,255,.08)}
    .linkbox{width:100%; min-height:76px; border-radius:12px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.04); color:var(--ink); padding:10px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; margin-top:10px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
    .start-screen{padding:20px; border:1px solid rgba(255,255,255,.1); border-radius:16px; background:var(--card); text-align:center}
    .start-screen h2{margin-top:0}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid rgba(255,255,255,.1); border-radius:999px; background:rgba(255,255,255,.03)}
    .sub{font-size:13px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="title">4 Gewinnt â€“ Tier-Duell</h1>
      <div class="controls">
        <button id="btn-new">Neue Serie</button>
      </div>
    </header>

    <div id="start-area" class="start-screen" style="display:none">
      <h2>WÃ¤hlt eure Tiere</h2>
      <p class="sub">Spieler 1 ist <b>ðŸ”´ Rot</b>, Spieler 2 ist <b>ðŸŸ¡ Gelb</b>. Danach wÃ¤hlt ihr, wer startet.</p>

      <div class="row" style="justify-content:center">
        <span class="pill">
          <b>Spieler 1 (ðŸ”´)</b>
          <select id="pick-p1"></select>
        </span>
        <span class="pill">
          <b>Spieler 2 (ðŸŸ¡)</b>
          <select id="pick-p2"></select>
        </span>
      </div>

      <h2 style="margin-top:18px">Wer startet?</h2>
      <div class="row" style="justify-content:center">
        <button id="start-p1">Spieler 1 beginnt</button>
        <button id="start-p2">Spieler 2 beginnt</button>
      </div>
      <p class="note">Tipp: Schick den Start-Link an beide â€“ dann ist klar, wer dran ist.</p>
    </div>

    <div id="game-area" style="display:none">
      <div class="status">
        <div class="who">
          <span id="turn-dot" class="disc red" aria-hidden="true"></span>
          <span id="status-text">â€¦</span>
        </div>
        <div class="note">Nach deinem Zug erscheint ein Link. Schicke ihn dem/der anderen. Genau 1 Zug pro Link.</div>
      </div>

      <div class="board-wrap">
        <div id="board" class="board" role="grid" aria-label="Vier Gewinnt"></div>
      </div>

      <div id="share-area" style="display:none">
        <div class="row note">Sende diesen Link an deinen Mitspieler:</div>
        <textarea id="share-link" class="linkbox" readonly></textarea>
        <div class="row"><button id="btn-copy">Link kopieren</button></div>
      </div>
    </div>
  </div>

  <script>
    // --- Config ---
    const COLS=7, ROWS=6;
    const P1=1, P2=2; // P1 = rot, P2 = gelb

    // âœ… Tiere (mind. Hund dabei + "coole" Optionen)
    const ANIMALS = {
      dog:   { emoji:"ðŸ¶", name:"Hund" },
      cat:   { emoji:"ðŸ±", name:"Katze" },
      owl:   { emoji:"ðŸ¦‰", name:"Eule" },
      zebra: { emoji:"ðŸ¦“", name:"Zebra" },
      fox:   { emoji:"ðŸ¦Š", name:"Fuchs" },
      wolf:  { emoji:"ðŸº", name:"Wolf" },
      panda: { emoji:"ðŸ¼", name:"Panda" },
      lion:  { emoji:"ðŸ¦", name:"LÃ¶we" },
      tiger: { emoji:"ðŸ¯", name:"Tiger" },
      shark: { emoji:"ðŸ¦ˆ", name:"Hai" },
      dragon:{ emoji:"ðŸ‰", name:"Drache" },
      unicorn:{emoji:"ðŸ¦„", name:"Einhorn" },
      monkey:{ emoji:"ðŸµ", name:"Affe" },
      frog:  { emoji:"ðŸ¸", name:"Frosch" }
    };

    const DOT = { [P1]:"red", [P2]:"yellow" };

    // --- DOM ---
    const $ = s => document.querySelector(s);
    const $board = $("#board");
    const $status = $("#status-text");
    const $dot = $("#turn-dot");
    const $shareLink = $("#share-link");
    const $title = $("#title");

    // --- URL Params ---
    const Q = new URLSearchParams(location.search);
    const movesStr = Q.get("m") || "";
    // Starter: '1' oder '2'
    const rawStarter = Q.get("st");
    const starter = (rawStarter === "1" || rawStarter === "2") ? parseInt(rawStarter,10) : null;
    // Wer darf diesen Link spielen: '1' oder '2'
    const rawTo = Q.get("to");
    let to = (rawTo === "1" || rawTo === "2") ? parseInt(rawTo,10) : null;

    // Tiere der Spieler
    const p1Key = validAnimal(Q.get("p1")) ? Q.get("p1") : "owl";
    const p2Key = validAnimal(Q.get("p2")) ? Q.get("p2") : "zebra";

    function validAnimal(k){ return !!(k && ANIMALS[k]); }
    function animalLabel(player){
      const k = (player===P1) ? p1Key : p2Key;
      const a = ANIMALS[k];
      return `${a.emoji} ${a.name}`;
    }

    function baseUrl(){ return location.origin + location.pathname; }

    // Link-Builder
    function makeLink(mStr, st, toWho, a1, a2){
      const u = new URL(baseUrl());
      if (mStr) u.searchParams.set("m", mStr);
      if (st)   u.searchParams.set("st", String(st));
      if (toWho)u.searchParams.set("to", String(toWho));
      u.searchParams.set("p1", a1);
      u.searchParams.set("p2", a2);
      return u.toString();
    }

    function updateTitle(){
      $title.textContent = `4 Gewinnt â€“ ${animalLabel(P1)} (ðŸ”´) vs. ${animalLabel(P2)} (ðŸŸ¡)`;
      document.title = $title.textContent;
    }

    // --- Startscreen oder Spiel ---
    if (!movesStr && !starter){
      $("#start-area").style.display = "block";
      $("#game-area").style.display = "none";

      // Dropdowns fÃ¼llen
      const p1Sel = $("#pick-p1");
      const p2Sel = $("#pick-p2");

      const keys = Object.keys(ANIMALS);
      for (const k of keys){
        const opt1 = document.createElement("option");
        opt1.value = k;
        opt1.textContent = `${ANIMALS[k].emoji} ${ANIMALS[k].name}`;
        p1Sel.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = k;
        opt2.textContent = `${ANIMALS[k].emoji} ${ANIMALS[k].name}`;
        p2Sel.appendChild(opt2);
      }

      // Defaults
      p1Sel.value = "dog";   // âœ… Hund ist Standard fÃ¼r Spieler 1
      p2Sel.value = "zebra";

      function renderStartTitle(){
        const a1 = p1Sel.value, a2 = p2Sel.value;
        $("#start-p1").textContent = `${ANIMALS[a1].emoji} ${ANIMALS[a1].name} beginnt`;
        $("#start-p2").textContent = `${ANIMALS[a2].emoji} ${ANIMALS[a2].name} beginnt`;
        $title.textContent = `4 Gewinnt â€“ ${ANIMALS[a1].emoji} ${ANIMALS[a1].name} (ðŸ”´) vs. ${ANIMALS[a2].emoji} ${ANIMALS[a2].name} (ðŸŸ¡)`;
        document.title = $title.textContent;
      }
      p1Sel.onchange = renderStartTitle;
      p2Sel.onchange = renderStartTitle;
      renderStartTitle();

      $("#start-p1").onclick = ()=> location.href = makeLink("", 1, 1, p1Sel.value, p2Sel.value);
      $("#start-p2").onclick = ()=> location.href = makeLink("", 2, 2, p1Sel.value, p2Sel.value);

    } else {
      $("#start-area").style.display = "none";
      $("#game-area").style.display = "block";
      updateTitle();
      startGame();
    }

    // --- Spielstart ---
    function startGame(){
      let board = Array.from({length:ROWS}, ()=> Array(COLS).fill(0));
      let lastMove = null;

      const whoAfterIndex = (i)=> (i % 2 === 0) ? (starter || 1) : ((starter || 1) === 1 ? 2 : 1);
      const currentPlayer = ()=> whoAfterIndex(movesStr.length);

      applyMovesFromString(movesStr);

      let winnerInfo = computeWinnerInfo();
      const fullAtStart = isBoardFull();

      // to sanity: falls fehlt oder inkonsistent -> currentPlayer
      if (!to || to !== currentPlayer()){
        to = currentPlayer();
        history.replaceState({}, "", makeLink(movesStr, starter || 1, to, p1Key, p2Key));
      }

      buildBoard();
      paintBoard();
      updateStatus();

      if (winnerInfo || fullAtStart) disableInput();

      function applyMovesFromString(mStr){
        for(let i=0;i<mStr.length;i++){
          const col = parseInt(mStr[i],10);
          const player = whoAfterIndex(i);
          const row = findDropRow(col);
          if(row === -1) break;
          board[row][col] = player;
          lastMove = {col,row,player};
        }
      }

      function buildBoard(){
        $board.style.setProperty("--cols", COLS);
        $board.style.setProperty("--rows", ROWS);
        $board.innerHTML = "";
        for (let c=0;c<COLS;c++){
          const col = document.createElement("div");
          col.className = "col";
          col.dataset.col = c;
          col.addEventListener("click", onColumnClick);
          for (let r=0;r<ROWS;r++){
            const cell = document.createElement("div");
            cell.className = "cell";
            const chip = document.createElement("div");
            chip.className = "chip";
            cell.appendChild(chip);
            col.appendChild(cell);
          }
          $board.appendChild(col);
        }
      }

      function paintBoard(){
        for(let r=0;r<ROWS;r++){
          for(let c=0;c<COLS;c++){
            const v = board[r][c];
            const cell = getCellEl(c,r);
            const chip = cell.querySelector(".chip");
            chip.className = "chip" + (v? " show " + (v===P1? "red":"yellow") : "");
            cell.classList.remove("last","win");
          }
        }
        if(lastMove) getCellEl(lastMove.col,lastMove.row).classList.add("last");
        if (winnerInfo){
          for(const {c,r} of winnerInfo.line){ getCellEl(c,r).classList.add("win"); }
        }
      }

      function getCellEl(c,r){ return $board.children[c].children[r]; }
      function findDropRow(col){ for(let r=ROWS-1;r>=0;r--) if(board[r][col]===0) return r; return -1; }
      function isBoardFull(){ return board.every(row => row.every(v => v!==0)); }

      function updateStatus(){
        // Titel aktualisieren (falls Link geteilt wurde)
        updateTitle();

        if (winnerInfo){
          $status.innerHTML = `Sieg! ${animalLabel(winnerInfo.player)} hat 4 in einer Linie.`;
          $dot.className = "disc " + (winnerInfo.player===P1? "red":"yellow");
          showShare(false);
          return;
        }
        if (isBoardFull()){
          $status.textContent = "Unentschieden â€“ Brett ist voll.";
          $dot.className = "disc";
          showShare(false);
          return;
        }

        const p = currentPlayer();
        $status.innerHTML = `${animalLabel(p)} ist dran`;
        $dot.className = "disc " + (p===P1? "red":"yellow");

        if (to !== p){ disableInput(); showShare(false); }
        else { enableInput(); showShare(false); }
      }

      function onColumnClick(e){
        if (winnerInfo || isBoardFull()) return;

        const p = currentPlayer();
        if (to !== p) return;

        const col = parseInt(e.currentTarget.dataset.col,10);
        const row = findDropRow(col);
        if (row === -1) return;

        board[row][col] = p;
        lastMove = {col,row,player:p};

        const chip = getCellEl(col,row).querySelector(".chip");
        chip.className = "chip " + (p===P1? "red":"yellow");
        requestAnimationFrame(()=> chip.classList.add("show"));

        winnerInfo = computeWinnerInfo();
        paintBoard();
        const full = isBoardFull();

        const nextMoves = movesStr + String(col);
        const nextTo = (p===P1) ? P2 : P1;
        const link = makeLink(nextMoves, starter || 1, nextTo, p1Key, p2Key);

        disableInput();

        if (winnerInfo || full){
          $status.innerHTML = winnerInfo ? `Sieg! ${animalLabel(winnerInfo.player)} hat 4 in einer Linie.` : `Unentschieden â€“ Brett voll.`;
          $dot.className = "disc " + (winnerInfo ? (winnerInfo.player===P1? "red":"yellow") : "");
          showShare(true, link);
        } else {
          $status.innerHTML = `Zug gesetzt. Sende den Link an ${animalLabel(nextTo)}.`;
          $dot.className = "disc " + (p===P1? "yellow":"red");
          showShare(true, link);
        }
      }

      function disableInput(){ Array.from($board.children).forEach(col=>col.classList.add("disabled")); }
      function enableInput(){ Array.from($board.children).forEach(col=>col.classList.remove("disabled")); }

      function showShare(show, link=""){
        const share = $("#share-area");
        share.style.display = show ? "block" : "none";
        if (show){
          $shareLink.value = link;
          $("#btn-copy").onclick = async ()=>{
            try{ await navigator.clipboard.writeText(link); $("#btn-copy").textContent="Kopiert âœ…"; }catch(e){}
          };
        }
      }

      function computeWinnerInfo(){
        if (!lastMove) return null;
        const {col,row,player} = lastMove;
        const dirs=[{dc:1,dr:0},{dc:0,dr:1},{dc:1,dr:1},{dc:1,dr:-1}];
        for(const d of dirs){
          const line=collectLine(col,row,d.dc,d.dr,player);
          if(line.length>=4){ return {player,line:line.slice(0,4)}; }
        }
        return null;
      }
      function collectLine(c,r,dc,dr,player){
        const cells=[{c,r}];
        let cc=c+dc,rr=r+dr;
        while(inBounds(cc,rr)&&board[rr][cc]===player){ cells.push({c:cc,r:rr}); cc+=dc; rr+=dr; }
        cc=c-dc; rr=r-dr;
        while(inBounds(cc,rr)&&board[rr][cc]===player){ cells.unshift({c:cc,r:rr}); cc-=dc; rr-=dr; }
        return cells;
      }
      function inBounds(c,r){ return c>=0&&c<COLS&&r>=0&&r<ROWS; }

      $("#btn-new").addEventListener("click", ()=> location.href = baseUrl());
    }
  </script>
</body>
</html>
